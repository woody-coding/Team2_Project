<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<script src="/js/jquery-3.7.1.min.js"></script>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" th:href="@{/css/admin/adminShowInsert.css}">

</head>
<body>
    <form action="/admin/showInsert" method="post" enctype="multipart/form-data">
        <section class="text-area">
            <div class="posterBox">
                <div class="poster" id="poster" style="background-size: cover; background-position: center; background-repeat: no-repeat;">
                    사진을 선택해주세요
                </div>
                <input type="file" name="file" id="fileInput" style="display: none;" accept=".jpg, .jpeg, .png"/>
            </div>
            <div class="showInfoBox" style="margin-left: 50px;margin-right: 50px;">
                <div class="title-input-container">
                    <span class="title">제 목</span>
                    <input type="text" name="showTitle" class="input-title-field input" placeholder="제목을 입력해주세요" style="width: 278px; margin-left: 55px;"/>
                </div>
                <div class="place-container">
                    <span class="title">공연 장소</span>
                    <input type="text" name="showPlace" class="place-field input" value="멀티캠퍼스 멀티24 3층 1홀" readonly style="width: 280px;"/>
                </div>
                <div class="category-container">
                    <span class="title">공연 카테고리</span>
                    <select name="showCate" class="input" required>
                        <option value="">선택하세요</option>
                        <option value="뮤지컬">뮤지컬</option>
                        <option value="콘서트">콘서트</option>
                        <option value="스포츠">스포츠</option>
                        <option value="전시/행사">전시/행사</option>
                        <option value="클래식">클래식</option>
                        <option value="아동/가족">아동/가족</option>
                        <option value="연극">연극</option>
                    </select>
                </div>
                <div class="date-container">
                    <span class="title">공연 기간</span>
                    <input type="text" id="startDateField" name="startDate" class="start-date-field input" placeholder="시작 날짜" readonly style="width: 115px; margin-right: 8px;"/>
                    <span class="title">~</span>
                    <input type="text" id="endDateField" name="endDate" class="end-date-field input" placeholder="종료 날짜" readonly style="width: 115px; margin-left: 8px;"/>
                	<input type="hidden" name="openDate" id="openDateField" />
                </div>
                <div class="count-container">
    				<span class="title">회 차</span>
				    <input type="text" id="countInput1" class="input-field input" value="1회" readonly style="margin-left: 54px; margin-right: 16px;" />
    <input type="time" id="timeInput1" name="showStartTime" step="3600" required style="display: inline-block;" />
					<span class="title">러닝 타임</span>
                    <input type="text" id="playtime" name="showPlayTime" class="input-showPlayTime-field input" placeholder="몇분" style="width: 42px; margin-left: 10px;">
                    <span class="minute">분</span>
				</div>

                <div class="age-seat-container">
                    <span class="title">관람 연령</span>
                    <select id="ageSelect" name="showRating" class="age-select input" style="margin-left: 17px;">
                        <option value="전체 이용가">전체 이용가</option>
                        <option value="12">12세</option>
                        <option value="15">15세</option>
                        <option value="19">19세</option>
                    </select>
                    <span class="title input">좌석 수</span>
                    <input type="text" class="input-price-field input" value="45" readonly style="width: 51px;"/>
                    <span class="seat">석</span>
                </div>
                <div class="price-container">
                    <span class="title">가 격</span>
                    <input type="text" id="inputPriceField" name="showPrice" class="input-price-field input" placeholder="가격" style="width: 100px; margin-left: 53px;">
                    <span class="won">원</span>
                </div>  
            </div>
            <div class="calender-container" style="border: 1px solid #dddddd;height: 285px;margin-top: -22px;border-radius: 6px;width: 320px;">
                <div class="calendar-header">
                    <button type="button" id="prevMonth">&lt;</button>
                    <span id="currentMonthYear">December 2024</span>
                    <button type="button" id="nextMonth">&gt;</button>
                </div>
                <div class="calendar-days" id="calendarDays"></div>
            </div>  
            <button type="button" id="resetSelection" class="fixed-button">재선택</button>    
        </section>
<section class="actor-area">
    <div class="actor-container">
        <span class="title title-actor" style="margin-right: 1002px;">출연 배우</span>
        <div class="actor-input-container">
            <div class="actBox" id="actBox_0">
                <div class="actImg">
                    <img alt="" src="/images/admin/default.png" class="actor" id="actorImage_0">
                </div>
                <div class="actName" id="actorName_0" name="actorName" style="margin-top: 10px;"></div>
            </div>
            <div class="actBox" id="actBox_1">
                <div class="actImg">
                    <img alt="" src="/images/admin/default.png" class="actor" id="actorImage_1">
                </div>
                <div class="actName" id="actorName_1" name="actorName" style="margin-top: 10px;"></div>
            </div>
            <div class="actBox" id="actBox_2">
                <div class="actImg">
                    <img alt="" src="/images/admin/default.png" class="actor" id="actorImage_2">
                </div>
                <div class="actName" id="actorName_2" name="actorName" style="margin-top: 10px;"></div>
            </div>
            <div class="actBox" id="actBox_3">
                <div class="actImg">
                    <img alt="" src="/images/admin/default.png" class="actor" id="actorImage_3">
                </div>
                <div class="actName" id="actorName_3" name="actorName" style="margin-top: 10px;"></div>
            </div>
            <div class="actBox" id="actBox_4">
                <div class="actImg">
                    <img alt="" src="/images/admin/default.png" class="actor" id="actorImage_4">
                </div>
                <div class="actName" id="actorName_4" name="actorName" style="margin-top: 10px;"></div>
            </div>
            <div class="actBox" id="actBox_5">
                <div class="actImg">
                    <img alt="" src="/images/admin/default.png" class="actor" id="actorImage_5">
                </div>
                <div class="actName" id="actorName_5" name="actorName" style="margin-top: 10px;"></div>
            </div>
        </div>
    </div>
</section>
        <section class="show-text-area">
            <div class="show-text-container" style="margin-top: 62px;margin-left: -85px;">
                <span class="title title-actor">공연 정보</span>
                <textarea name="showInfo" class="show-text-field" placeholder="공연정보를 입력해 주세요" style="width: 993px; height: 250px; display: block; margin-top: 10px; resize: none;" ></textarea>
                <button type="submit" class="register-button" style="margin-left: 93.3%;margin-top: 20px;padding: 10px 20px; background-color: #ff9400; color: white; border: none; border-radius: 5px; cursor: pointer;">등록</button>
            </div>
        </section>
        <input type="hidden" name="actorNo[]" id="actorNoField">
        <input type="hidden" name="roleName[]" id="roleNameField">
        <input type="hidden" name="likes" value="0">
    </form>
    <!-- 모달 컨테이너 -->
<div id="actorModal" class="modal" style="display: none;">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <div class="search-bar">
            <input type="text" id="actorSearchInput" placeholder="배우 이름을 입력하세요">
            <button id="actorSearchButton">검색</button>
        </div>
        <hr />
        <div class="modal-actor-info">
            <h3 class="modal-actor-name"></h3>
            <img class="modal-actor-image" src="" alt="배우 이미지">
        </div>
        <div class="separator"></div>
        <section class="actor-area" id="actorSearchResults"></section>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        let selectedActors = []; // 선택된 배우 정보를 저장할 배열

        // 포스터 클릭 시 파일 입력 열기
        document.getElementById('poster').addEventListener('click', function() {
            document.getElementById('fileInput').click();
        });

        // 파일 선택 시 미리보기 업데이트
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.querySelector('.poster').style.backgroundImage = `url(${e.target.result})`;
                };
                reader.readAsDataURL(file);
            }
        });

        // 시간 입력 필드 설정
        function setupTimeInput(countInputId, timeInputId) {
            document.getElementById(countInputId).addEventListener('click', function() {
                const timeInput = document.getElementById(timeInputId);
                timeInput.style.display = 'inline-block';
                timeInput.focus();
            });

            document.getElementById(timeInputId).addEventListener('change', function() {
                const selectedTime = this.value;
                const formattedTime = `${selectedTime}:00`;
                document.getElementById(countInputId).value = formattedTime;
            });
        }

        setupTimeInput('countInput1', 'timeInput1');

        // 가격 입력 필드 포맷팅
        document.getElementById('inputPriceField').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9]/g, '');
            value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            e.target.value = value;
        });

        // 달력 관련 변수
        let isStartDateSelected = false;
        let startDate = null;
        let endDate = null;
        let currentDate = new Date();

        // 달력 렌더링 함수
        function renderCalendar() {
            const currentYear = currentDate.getFullYear();
            const currentMonth = currentDate.getMonth();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            document.getElementById('currentMonthYear').textContent = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;

            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const selectedDate = new Date(dateStr);

                dayCell.textContent = day;
                dayCell.classList.add('day');
                dayCell.setAttribute('data-date', dateStr);

                if (isStartDateSelected && selectedDate < startDate) {
                    dayCell.classList.add('disabled');
                }

                if (endDate && selectedDate > endDate) {
                    dayCell.classList.add('disabled');
                }

                dayCell.addEventListener('click', () => handleDateSelection(dayCell, selectedDate));

                calendarDays.appendChild(dayCell);
            }
        }

        function handleDateSelection(dayCell, selectedDate) {
            if (dayCell.classList.contains('disabled')) return;

            document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
            dayCell.classList.add('selected');

            if (!isStartDateSelected) {
                startDate = selectedDate;
                isStartDateSelected = true;
                document.getElementById('startDateField').value = dayCell.getAttribute('data-date');

                document.querySelectorAll('.day').forEach(el => {
                    const elDate = new Date(el.getAttribute('data-date'));
                    if (elDate < startDate) el.classList.add('disabled');
                });
            } else {
                endDate = selectedDate;
                isStartDateSelected = false;
                document.getElementById('endDateField').value = dayCell.getAttribute('data-date');

                document.querySelectorAll('.day').forEach(el => {
                    const elDate = new Date(el.getAttribute('data-date'));
                    el.classList.toggle('selected-range', elDate >= startDate && elDate <= endDate);
                    if (elDate > endDate) el.classList.add('disabled');
                });
            }
        }

        // 달력 탐색 버튼
        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        document.getElementById('resetSelection').addEventListener('click', () => {
            isStartDateSelected = false;
            startDate = null;
            endDate = null;
            document.getElementById('startDateField').value = '';
            document.getElementById('endDateField').value = '';
            document.querySelectorAll('.selected, .disabled, .selected-range').forEach(el => el.classList.remove('selected', 'disabled', 'selected-range'));
        });

        renderCalendar();

        // 현재 선택된 actBox의 인덱스를 저장할 변수
        let currentActBoxIndex = null;

        // actBox 클릭 시 인덱스 저장 및 모달 열기
        document.querySelectorAll('.actBox').forEach((box, index) => {
            box.addEventListener('click', function() {
                openActorModal(index);
            });
        });

        // 모달 열기
        function openActorModal(index) {
            const modal = document.getElementById('actorModal');
            modal.style.display = 'flex';

            // 배우 검색 버튼 클릭 시
            document.getElementById('actorSearchButton').addEventListener('click', function(event) {
                event.preventDefault();
                const searchTerm = document.getElementById('actorSearchInput').value.trim();

                if (!searchTerm) return alert('검색어를 입력하세요.');

                fetch(`/admin/searchActor?actorName=${encodeURIComponent(searchTerm)}`)
                    .then(res => res.json())
                    .then(data => {
                        const resultsContainer = document.getElementById('actorSearchResults');
                        resultsContainer.innerHTML = '';

                        if (!data || !data.length) {
                            resultsContainer.innerHTML = '<p>검색 결과가 없습니다.</p>';
                            return;
                        }

                        data.forEach((actor) => {
                            const actorDiv = document.createElement('div');
                            actorDiv.classList.add('actor-item');
                            actorDiv.innerHTML = `
                                <img src="/uploads/${actor.fileNo || 'default.jpg'}" alt="${actor.actorName || '이미지 없음'}" style="width: 100px; height: auto;" />
                                <h4>${actor.actorName || '이름 없음'}</h4>
                            `;

                            // 배우 선택 시 배열에 추가
                            actorDiv.addEventListener('click', function() {
                                selectedActors[index] = {
                                    actorNo: actor.actorNo,
                                    actorName: actor.actorName
                                };
                                closeActorModal();
                                updateActBox(index, actor);
                            });

                            resultsContainer.appendChild(actorDiv);
                        });
                    })
                    .catch(err => {
                        console.error('Error fetching actor data:', err);
                        resultsContainer.innerHTML = '<p>검색 중 오류가 발생했습니다.</p>';
                    });
            });
        }

        // 모달 닫기
        function closeActorModal() {
            const modal = document.getElementById('actorModal');
            modal.style.display = 'none';
        }

        // actBox 업데이트
        function updateActBox(index, actor) {
            const actBox = document.getElementById(`actBox_${index}`);
            const actImg = actBox.querySelector('.actImg img');
            const actName = actBox.querySelector('.actName');
            actImg.src = `/uploads/${actor.fileNo || 'default.jpg'}`;
            actName.textContent = actor.actorName || '이름 없음';
        }

        // 폼 제출 시 선택된 배우 정보 전송
        document.querySelector('form').addEventListener('submit', function(event) {
            // null 값을 제거하고 선택된 배우만 전송
            selectedActors.filter(actor => actor != null).forEach((actor, index) => {
                const actorNoInput = document.createElement('input');
                actorNoInput.type = 'hidden';
                actorNoInput.name = 'actorNo[]';
                actorNoInput.value = actor.actorNo;
                this.appendChild(actorNoInput);

                const roleNameInput = document.createElement('input');
                roleNameInput.type = 'hidden';
                roleNameInput.name = 'roleName[]';
                roleNameInput.value = index < 2 ? '주연' : '조연'; // 예시로 주연/조연 구분
                this.appendChild(roleNameInput);
            });
        });

        // startDate 변경 시 openDate 계산
        document.getElementById('startDateField').addEventListener('change', function() {
            const startDateValue = this.value;
            if (startDateValue) {
                const startDateObj = new Date(startDateValue);
                startDateObj.setDate(startDateObj.getDate() - 20);
                document.getElementById('openDateField').value = startDateObj.toISOString().split('T')[0];
            }
        });
    });
</script>

</body>
</html>